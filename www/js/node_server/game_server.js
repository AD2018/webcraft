import {World} from "../world.js";
import {Player} from "../player.js";
import {ServerClient} from "../server_client.js";

import {WebSocketServer, WebSocket} from "ws";
import url from 'url';

export class GameServer {

    constructor() {
        this.is_server = true;
        // Worlds
        this.worlds = new Map();
        // Placeholder
        this.hud = {
            add: () => {},
            refresh: () => {}
        };
        this.hotbar = {
            setInventory: (items) => {}
        }
    }

    // startWS...
    startWS() {

        // Create websocket server
        this.wsServer = new WebSocketServer({
            port: 5701
        });
        this.wsServer.on('connection', async (conn, req) => {
            //
            console.log('New player connection');
            //
            conn.sendMixed = function(commands) {
                for(let cmd of commands) {
                    console.log('> player ' + ServerClient.getCommandTitle(cmd.name));
                }
                this.send(JSON.stringify(commands));
            }
            // On player disconnected
            conn.on('close', code => {
                let session = conn.player.session;
                if(session) {
                    conn.player.world.server.RemovePlayerListeners(session.user_guid);
                    console.log('Player disconnected ' + session.username);
                } else {
                    console.log('Player disconnected');
                }
            });
            // On player command
            conn.on('message', cmd => {
                cmd = JSON.parse(cmd);
                console.log('player > ' + ServerClient.getCommandTitle(cmd.name));
                switch(cmd.name) {
                    case ServerClient.CMD_CONNECT: {
                        conn.sendMixed([{"name": ServerClient.CMD_CONNECTED, "data":{"session":{"user_id":1001,"user_guid":"e953ac26-5e68-432a-886a-226708ca1bbf","username":"sciner","session_id":"a31dbfed-b914-4c22-80eb-6fa0484af8e7"},"state":{"pos_spawn":{"x":2896.224,"y":67,"z":2795.525},"pos":{"x":2896.224,"y":67,"z":2795.525},"rotate":{"x":0,"y":0,"z":0},"flying":false,"inventory":{"items":[{"id":461,"power":1,"rotate":{"x":0,"y":0,"z":0},"count":1},{"id":53,"power":1,"rotate":{"x":0,"y":0,"z":0},"count":1},{"id":65,"power":1,"rotate":{"x":0,"y":0,"z":0},"count":1},{"id":463,"power":1,"rotate":{"x":0,"y":0,"z":0},"count":1},{"id":2,"power":1,"rotate":{"x":0,"y":0,"z":0},"count":1},{"id":533,"power":1,"rotate":{"x":0,"y":0,"z":0},"count":1},{"id":134,"power":1,"rotate":{"x":0,"y":0,"z":0},"count":1},{"id":58,"power":1,"rotate":{"x":0,"y":0,"z":0},"count":1},{"id":106,"power":1,"rotate":{"x":0,"y":0,"z":0},"count":1},{"id":13,"power":1,"rotate":{"x":0,"y":0,"z":0},"count":1},{"id":353,"power":1,"rotate":{"x":0,"y":0,"z":0},"count":1},{"id":11,"power":1,"rotate":{"x":0,"y":0,"z":0},"count":1},{"id":138,"power":1,"rotate":{"x":0,"y":0,"z":0},"count":1},{"id":8,"power":1,"rotate":{"x":0,"y":0,"z":0},"count":1},{"id":233,"power":1,"rotate":{"x":0,"y":0,"z":0},"count":3},{"id":145,"power":1,"rotate":{"x":0,"y":0,"z":0},"count":1},{"id":53,"power":1,"rotate":{"x":0,"y":0,"z":0},"count":1},{"id":31,"power":1,"rotate":{"x":0,"y":0,"z":0},"count":1},{"id":2,"power":1,"rotate":{"x":0,"y":0,"z":0},"count":2},{"id":3,"power":1,"rotate":{"x":0,"y":0,"z":0},"count":1},{"id":163,"power":1,"rotate":{"x":0,"y":0,"z":0},"count":1},{"id":50,"power":1,"rotate":{"x":0,"y":0,"z":0},"count":2},{"id":106,"power":1,"rotate":{"x":0,"y":0,"z":0},"count":1},{"id":98,"power":1,"rotate":{"x":0,"y":0,"z":0},"count":1},{"id":109,"power":1,"rotate":{"x":0,"y":0,"z":0},"count":1},{"id":135,"power":1,"rotate":{"x":0,"y":0,"z":0},"count":1},{"id":191,"power":1,"rotate":{"x":0,"y":0,"z":0},"count":1},{"id":189,"power":1,"rotate":{"x":0,"y":0,"z":0},"count":1},{"id":134,"power":1,"rotate":{"x":0,"y":0,"z":0},"count":64},{"id":85,"power":1,"rotate":{"x":0,"y":0,"z":0},"count":2},{"id":7,"power":1,"rotate":{"x":0,"y":0,"z":0},"count":1},{"id":9,"power":1,"rotate":{"x":0,"y":0,"z":0},"count":1},{"id":17,"power":1,"rotate":{"x":0,"y":0,"z":0},"count":2},{"id":126,"power":1,"rotate":{"x":0,"y":0,"z":0},"count":1},{"id":539,"power":1,"rotate":{"x":0,"y":0,"z":0},"count":1},null],"current":{"index":2}},"indicators":{"live":{"name":"live","value":5},"food":{"name":"food","value":20},"oxygen":{"name":"oxygen","value":10}}}},"id":null}]);
                        conn.sendMixed([{"name": ServerClient.CMD_NEARBY_MODIFIED_CHUNKS,"data":[{"x":172,"y":1,"z":175},{"x":172,"y":1,"z":176},{"x":172,"y":1,"z":177},{"x":172,"y":2,"z":167},{"x":172,"y":2,"z":168},{"x":172,"y":2,"z":171},{"x":172,"y":2,"z":172},{"x":172,"y":3,"z":166},{"x":172,"y":3,"z":167},{"x":172,"y":3,"z":168},{"x":172,"y":4,"z":166},{"x":173,"y":1,"z":174},{"x":173,"y":1,"z":175},{"x":173,"y":1,"z":176},{"x":173,"y":2,"z":166},{"x":173,"y":2,"z":168},{"x":173,"y":2,"z":169},{"x":173,"y":2,"z":170},{"x":173,"y":3,"z":166},{"x":173,"y":3,"z":167},{"x":173,"y":3,"z":168},{"x":174,"y":1,"z":174},{"x":174,"y":1,"z":175},{"x":174,"y":1,"z":176},{"x":174,"y":2,"z":168},{"x":174,"y":2,"z":169},{"x":174,"y":2,"z":171},{"x":175,"y":1,"z":165},{"x":175,"y":1,"z":174},{"x":175,"y":1,"z":175},{"x":175,"y":1,"z":176},{"x":175,"y":2,"z":169},{"x":175,"y":2,"z":171},{"x":176,"y":1,"z":165},{"x":176,"y":1,"z":170},{"x":176,"y":1,"z":171},{"x":176,"y":1,"z":173},{"x":176,"y":1,"z":174},{"x":176,"y":1,"z":175},{"x":176,"y":1,"z":176},{"x":176,"y":2,"z":167},{"x":176,"y":2,"z":169},{"x":176,"y":2,"z":170},{"x":176,"y":2,"z":171},{"x":176,"y":2,"z":173},{"x":177,"y":-1,"z":174},{"x":177,"y":-1,"z":175},{"x":177,"y":1,"z":165},{"x":177,"y":1,"z":167},{"x":177,"y":1,"z":168},{"x":177,"y":1,"z":170},{"x":177,"y":1,"z":172},{"x":177,"y":1,"z":173},{"x":177,"y":1,"z":174},{"x":177,"y":1,"z":175},{"x":177,"y":1,"z":176},{"x":177,"y":1,"z":177},{"x":177,"y":2,"z":175},{"x":178,"y":-1,"z":174},{"x":178,"y":-1,"z":175},{"x":178,"y":-1,"z":176},{"x":178,"y":-1,"z":177},{"x":178,"y":-1,"z":178},{"x":178,"y":-1,"z":179},{"x":178,"y":-1,"z":180},{"x":178,"y":-1,"z":181},{"x":178,"y":-1,"z":182},{"x":178,"y":1,"z":168},{"x":178,"y":1,"z":169},{"x":178,"y":1,"z":170},{"x":178,"y":1,"z":172},{"x":178,"y":1,"z":173},{"x":178,"y":1,"z":174},{"x":178,"y":1,"z":175},{"x":178,"y":1,"z":176},{"x":178,"y":1,"z":177},{"x":178,"y":2,"z":172},{"x":178,"y":2,"z":173},{"x":178,"y":2,"z":174},{"x":178,"y":2,"z":175},{"x":178,"y":2,"z":176},{"x":178,"y":2,"z":177},{"x":178,"y":2,"z":178},{"x":178,"y":3,"z":173},{"x":178,"y":3,"z":174},{"x":178,"y":3,"z":175},{"x":178,"y":3,"z":177},{"x":178,"y":3,"z":178},{"x":178,"y":4,"z":175},{"x":178,"y":5,"z":175},{"x":179,"y":-1,"z":174},{"x":179,"y":-1,"z":175},{"x":179,"y":-1,"z":176},{"x":179,"y":1,"z":168},{"x":179,"y":1,"z":170},{"x":179,"y":1,"z":171},{"x":179,"y":1,"z":172},{"x":179,"y":1,"z":173},{"x":179,"y":1,"z":174},{"x":179,"y":1,"z":175},{"x":179,"y":1,"z":176},{"x":179,"y":1,"z":177},{"x":179,"y":1,"z":178},{"x":179,"y":1,"z":179},{"x":179,"y":2,"z":172},{"x":179,"y":2,"z":173},{"x":179,"y":2,"z":174},{"x":179,"y":2,"z":175},{"x":179,"y":2,"z":177},{"x":179,"y":3,"z":173},{"x":179,"y":3,"z":174},{"x":179,"y":3,"z":175},{"x":179,"y":3,"z":177},{"x":180,"y":-1,"z":173},{"x":180,"y":-1,"z":174},{"x":180,"y":-1,"z":175},{"x":180,"y":-1,"z":176},{"x":180,"y":1,"z":169},{"x":180,"y":1,"z":170},{"x":180,"y":1,"z":171},{"x":180,"y":1,"z":172},{"x":180,"y":1,"z":173},{"x":180,"y":1,"z":174},{"x":180,"y":1,"z":175},{"x":180,"y":1,"z":176},{"x":180,"y":1,"z":177},{"x":180,"y":1,"z":178},{"x":180,"y":2,"z":174},{"x":180,"y":2,"z":180},{"x":180,"y":3,"z":174},{"x":180,"y":3,"z":175},{"x":180,"y":3,"z":176},{"x":180,"y":3,"z":177},{"x":180,"y":3,"z":178},{"x":180,"y":4,"z":174},{"x":181,"y":-1,"z":173},{"x":181,"y":-1,"z":174},{"x":181,"y":-1,"z":175},{"x":181,"y":1,"z":170},{"x":181,"y":1,"z":171},{"x":181,"y":1,"z":172},{"x":181,"y":1,"z":173},{"x":181,"y":1,"z":174},{"x":181,"y":1,"z":175},{"x":181,"y":1,"z":176},{"x":181,"y":1,"z":177},{"x":181,"y":1,"z":178},{"x":181,"y":1,"z":179},{"x":181,"y":1,"z":180},{"x":181,"y":2,"z":177},{"x":181,"y":2,"z":180},{"x":182,"y":-1,"z":174},{"x":182,"y":-1,"z":175},{"x":182,"y":1,"z":169},{"x":182,"y":1,"z":170},{"x":182,"y":1,"z":171},{"x":182,"y":1,"z":172},{"x":182,"y":1,"z":173},{"x":182,"y":1,"z":174},{"x":182,"y":1,"z":175},{"x":182,"y":1,"z":176},{"x":182,"y":2,"z":173},{"x":182,"y":2,"z":174},{"x":182,"y":2,"z":175},{"x":183,"y":-1,"z":174},{"x":183,"y":-1,"z":175},{"x":183,"y":-1,"z":176},{"x":183,"y":1,"z":169},{"x":183,"y":1,"z":171},{"x":183,"y":1,"z":173},{"x":183,"y":1,"z":174},{"x":183,"y":1,"z":175},{"x":183,"y":1,"z":176},{"x":183,"y":2,"z":174},{"x":183,"y":2,"z":175},{"x":183,"y":2,"z":176},{"x":184,"y":-1,"z":175},{"x":184,"y":1,"z":168},{"x":184,"y":1,"z":169},{"x":184,"y":1,"z":171},{"x":184,"y":1,"z":172},{"x":184,"y":1,"z":173},{"x":184,"y":1,"z":174},{"x":184,"y":1,"z":175},{"x":184,"y":1,"z":176},{"x":184,"y":2,"z":171},{"x":184,"y":2,"z":172},{"x":184,"y":2,"z":176},{"x":185,"y":-1,"z":175},{"x":185,"y":1,"z":168},{"x":185,"y":1,"z":172},{"x":185,"y":1,"z":173},{"x":185,"y":1,"z":174},{"x":185,"y":1,"z":175},{"x":185,"y":1,"z":176},{"x":185,"y":1,"z":177},{"x":185,"y":1,"z":178},{"x":185,"y":2,"z":172},{"x":185,"y":2,"z":173},{"x":186,"y":-1,"z":175},{"x":186,"y":1,"z":165},{"x":186,"y":1,"z":166},{"x":186,"y":1,"z":167},{"x":186,"y":1,"z":168},{"x":186,"y":1,"z":169},{"x":186,"y":1,"z":170},{"x":186,"y":1,"z":171},{"x":186,"y":1,"z":172},{"x":186,"y":1,"z":173},{"x":186,"y":1,"z":174},{"x":186,"y":1,"z":175},{"x":186,"y":1,"z":176},{"x":186,"y":1,"z":177},{"x":186,"y":1,"z":178},{"x":186,"y":1,"z":179},{"x":186,"y":2,"z":173},{"x":186,"y":2,"z":174},{"x":186,"y":2,"z":175},{"x":186,"y":2,"z":176},{"x":187,"y":-1,"z":174},{"x":187,"y":-1,"z":175},{"x":187,"y":1,"z":165},{"x":187,"y":1,"z":166},{"x":187,"y":1,"z":167},{"x":187,"y":1,"z":168},{"x":187,"y":1,"z":169},{"x":187,"y":1,"z":170},{"x":187,"y":1,"z":171},{"x":187,"y":1,"z":172},{"x":187,"y":1,"z":173},{"x":187,"y":1,"z":174},{"x":187,"y":1,"z":175},{"x":187,"y":1,"z":176},{"x":187,"y":1,"z":177},{"x":187,"y":1,"z":178},{"x":187,"y":1,"z":179},{"x":187,"y":2,"z":167},{"x":187,"y":2,"z":168},{"x":187,"y":2,"z":169},{"x":187,"y":2,"z":170},{"x":187,"y":2,"z":171},{"x":187,"y":2,"z":173},{"x":187,"y":2,"z":174},{"x":187,"y":2,"z":175},{"x":187,"y":2,"z":176},{"x":188,"y":-1,"z":173},{"x":188,"y":-1,"z":174},{"x":188,"y":-1,"z":175},{"x":188,"y":1,"z":165},{"x":188,"y":1,"z":168},{"x":188,"y":1,"z":171},{"x":188,"y":1,"z":172},{"x":188,"y":1,"z":173},{"x":188,"y":1,"z":174},{"x":188,"y":1,"z":175},{"x":188,"y":1,"z":176},{"x":188,"y":1,"z":177},{"x":188,"y":1,"z":178},{"x":188,"y":2,"z":167},{"x":188,"y":2,"z":168},{"x":188,"y":2,"z":169},{"x":188,"y":2,"z":170},{"x":188,"y":2,"z":171},{"x":188,"y":2,"z":173},{"x":188,"y":2,"z":174},{"x":188,"y":2,"z":175},{"x":188,"y":2,"z":176},{"x":189,"y":1,"z":165},{"x":189,"y":1,"z":168},{"x":189,"y":1,"z":169},{"x":189,"y":1,"z":170},{"x":189,"y":1,"z":172},{"x":189,"y":1,"z":173},{"x":189,"y":1,"z":175},{"x":189,"y":1,"z":176},{"x":189,"y":1,"z":177},{"x":189,"y":1,"z":181},{"x":189,"y":2,"z":165},{"x":189,"y":2,"z":168},{"x":189,"y":2,"z":169},{"x":189,"y":2,"z":171},{"x":189,"y":2,"z":172}],"id":null}]);
                        // world.server.Send(cmd);
                        break;
                    }
                    case ServerClient.CMD_CHUNK_ADD: {
                        conn.sendMixed([{"name": ServerClient.CMD_CHUNK_LOADED, "data":{"pos": cmd.data.pos,"modify_list":{}},"id":null}]);
                        
                        break;
                    }
                }
            });
            // Connect to GO server
            let query = url.parse(req.url, true).query;
            let world_guid = query.world_guid;
            let go_server_url = 'ws://localhost:5700/ws';
            let world = this.worlds.get(world_guid);
            if(!world) {
                world = new World();
                let ws = new WebSocket(go_server_url + '?world_guid=' + world_guid);
                await world.connect(ws);
                this.worlds.set(world_guid, world);
                console.log('World started');
            }
            let player = new Player();
            player.joinToServerWorld(conn, world);
        });
    }

}